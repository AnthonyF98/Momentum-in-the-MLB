---
title: "Momentum in the MLB"
author: "Anthony Fernandez"
date: "2025-05-29"
output: html_document
---
```{r}
#devtools::install_github("billpetti/baseballr")

library(baseballr)
library(dplyr)
library(purrr)
library(lubridate)

# Load required packages
install.packages("data.table")  # Only run if needed
library(data.table)
library(dplyr)
library(purrr)

# Function to safely pull Statcast data from Baseball Savant
get_statcast_data_v2 <- function(start_date, end_date) {
  base_url <- "https://baseballsavant.mlb.com/statcast_search/csv?all=true"
  url <- paste0(
    base_url,
    "&hfPT=&hfAB=&hfBBT=&hfPR=&hfZ=&stadium=&hfBBL=&hfNewZones=&hfGT=R%7CPO%7CS%7C",
    "&hfC&hfSea=&hfSit=&hfOuts=&opponent=&pitcher_throws=&batter_stands=",
    "&hfSA=&player_type=batter&hfInfield=&team=&position=&hfOutfield=",
    "&hfRO=&home_road=&game_date_gt=", start_date,
    "&game_date_lt=", end_date,
    "&hfFlag=&hfPull=&metric_1=&hfInn=&min_pitches=0&min_results=0",
    "&group_by=name&sort_col=pitches&player_event_sort=h_launch_speed",
    "&sort_order=desc&min_abs=0&type=details"
  )
  
  message(paste("Downloading:", start_date, "to", end_date))
  
  tryCatch({
    df <- fread(url, showProgress = FALSE, fill = TRUE)
    df
  }, error = function(e) {
    message(paste("Failed:", e$message))
    return(NULL)
  })
}

# Create date ranges for COVID-shortened 2020 season
get_monthly_ranges_2020 <- function() {
  tibble(
    start = c("2020-07-23", "2020-08-01", "2020-09-01"),
    end   = c("2020-07-31", "2020-08-31", "2020-09-27")
  )
}

# Download and combine 2020 Statcast data
date_ranges_2020 <- get_monthly_ranges_2020()

statcast_2020 <- map2_dfr(date_ranges_2020$start, date_ranges_2020$end, get_statcast_data_v2)

# Save for reuse
saveRDS(statcast_2020, "statcast_2020.rds")

```

```{r}
#summary(statcast_2020)

cols_to_keep <- c(
  "game_pk",             # Game ID
  "game_date",           # Date of game
  "at_bat_number",       # Sequential number of PA in game
  "inning",              # Inning
  "inning_topbot",       # Top or Bottom of inning
  "batter",              # Batter ID
  "player_name",         # Batter name
  "events",              # Event result (e.g. 'single', 'groundout')
  "description",         # Useful for identifying completed PAs
  "home_team",           # Home team
  "away_team",           # Away team
  "bat_score",           # Score at the time
  "post_bat_score",      # Score after PA
  "home_score", "away_score", # Full context
  "pitch_number"         # Needed to make sure we're only using the final pitch of the PA
)

statcast_2020_clean <- statcast_2020 %>%
  select(all_of(cols_to_keep)) %>%
  filter(!is.na(events))  # Remove non-PA rows (e.g. pickoffs, warmups)

# Check result
glimpse(statcast_2020_clean)

unique(statcast_2020$events)


```
```{r}
# Keep only the final pitch of each at-bat (where event is not NA and last pitch_number per at_bat)
library(dplyr)

statcast_pa_2020 <- statcast_2020_clean %>%
  filter(!is.na(events), events != "") %>%
  group_by(game_pk, at_bat_number) %>%
  filter(pitch_number == max(pitch_number)) %>%
  ungroup()

```

```{r}
# Sort by game, inning, top/bot, and at-bat
statcast_pa_2020 <- statcast_pa_2020 %>%
  arrange(game_pk, inning, inning_topbot, at_bat_number) %>%
  group_by(game_pk, inning, inning_topbot) %>%
  mutate(
    prev_event = lag(events),
    prev_batter = lag(batter),
    momentum = ifelse(prev_event %in% c("single", "double", "triple", "home_run", "sac_fly"), 1, 0)
  ) %>%
  ungroup()

```

```{r}
# Calculate batting average with vs. without momentum
momentum_ba <- statcast_pa_2020 %>%
  filter(events %in% c("single", "double", "triple", "home_run", "field_out", "strikeout", "grounded_into_double_play")) %>%
  mutate(hit = ifelse(events %in% c("single", "double", "triple", "home_run"), 1, 0)) %>%
  group_by(momentum) %>%
  summarise(
    PA = n(),
    Hits = sum(hit),
    Batting_Average = mean(hit)
  )

print(momentum_ba)

```




############################################
########Break Down by Team##################
############################################

```{r}
statcast_pa_2020 <- statcast_pa_2020 %>%
  mutate(batting_team = ifelse(inning_topbot == "Top", away_team, home_team))

statcast_pa_2020 <- statcast_pa_2020 %>%
  mutate(hit = ifelse(events %in% c("single", "double", "triple", "home_run"), 1, 0))

```

```{r}
library(dplyr)

team_momentum_ba <- statcast_pa_2020 %>%
 filter(events %in% c(
    "single", "double", "triple", "home_run",
    "field_out", "strikeout", "grounded_into_double_play",
    "double_play", "strikeout_double_play",
    "fielders_choice", "force_out"
  )) %>%
  group_by(batting_team, momentum) %>%
  summarise(
    PA = n(),
    Hits = sum(hit),
    Batting_Average = mean(hit),
    .groups = "drop"
  )

```

```{r}
library(tidyr)

team_comparison <- team_momentum_ba %>%
  pivot_wider(
    names_from = momentum,
    values_from = c(PA, Hits, Batting_Average),
    names_prefix = "momentum_"
  ) %>%
  mutate(
    BA_Difference = Batting_Average_momentum_1 - Batting_Average_momentum_0
  ) %>%
  arrange(desc(BA_Difference))

# View top teams by momentum boost
print(team_comparison)

```

```{r}
# Filter valid at-bats and create the hit column
valid_pas <- statcast_pa_2020 %>%
  filter(events %in% c(
    "single", "double", "triple", "home_run",
    "field_out", "strikeout", "grounded_into_double_play",
    "double_play", "strikeout_double_play",
    "fielders_choice", "force_out"
  )) %>%
  mutate(hit = ifelse(events %in% c("single", "double", "triple", "home_run"), 1, 0))

# Run the t-test
t_test_result <- t.test(hit ~ momentum, data = valid_pas)

print(t_test_result)

```

```{r}
library(ggplot2)

ggplot(team_comparison, aes(x = reorder(batting_team, BA_Difference), y = BA_Difference, fill = BA_Difference > 0)) +
  geom_col(width = 0.7, color = "white", show.legend = FALSE) +
  scale_fill_manual(values = c("FALSE" = "#e74c3c", "TRUE" = "#2ecc71")) +  # red for negative, green for positive
  geom_text(aes(label = sprintf("%.3f", BA_Difference)), hjust = ifelse(team_comparison$BA_Difference > 0, -0.15, 1.1), 
            size = 3.5, color = "black") +
  coord_flip() +
  labs(
    title = "Which Teams Ride the Momentum?",
    subtitle = "Difference in Batting Average When Previous Batter Got a Hit or Sac Fly (2020)",
    x = "Team",
    y = "Momentum Batting Avg. Difference"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(color = "gray30", size = 12),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.y = element_text(face = "bold")
  ) +
  xlim(c(levels(reorder(team_comparison$batting_team, team_comparison$BA_Difference)), NA))

```

